---
title: 4.5 to 4.6
description: This guide covers upgrading a 4.5 Spree application to Spree 4.6.
---

<Note>
If you're on an older version than 4.5 please follow previous upgrade guides and perform those upgrades incrementally, e.g.

1. [upgrade 4.2 to 4.3](4.2-to-4.3)
2. [upgrade 4.3 to 4.4](4.3-to-4.4)
3. [upgrade 4.4 to 4.5](4.4-to-4.5)
</Note>

## Update Gemfile

```ruby
gem 'spree', '>= 4.6'
```

Update all other spree gems used in your application to 4.6.0 or version compatible with 4.6:

```ruby
gem 'spree_sample', '~> 4.6'
gem 'spree_emails', '~> 4.6'
gem 'spree_frontend', '>= 4.6'
gem 'spree_backend', '>= 4.6'
gem 'spree_gateway', '~> 3.10'
gem 'spree_auth_devise', '>= 4.5'
gem 'spree_i18n', '~> 5.1'
```

## (Optional) Remove spree\_globalize

If your application used the spree\_globalize extension, you can remove it from your Gemfile, as translations are now supported out-of-the-box with the [Mobility](https://github.com/shioyama/mobility) gem.

We've configured Mobility to use [a strategy that uses a separate table to store translations](https://dejimata.com/2017/3/3/translating-with-mobility#strategy-2), just like how spree\_globalize did. This means, you won't need to make any changes to the database structure or migrate data.

During the upgrade process, you may need to review your custom queries that rely on translations, as there are minor differences in how Mobility handles them. Spree 4.6 includes a few [built-in concerns](../../customization/i18n) to make it easier to work with translatable models.

## Update gems

```bash
bundle update
```

## Install missing migrations

```bash
bin/rake railties:install:migrations
```

## Run migrations

```bash
bin/rails db:migrate
```

Note: If you didn't use spree\_globalize before, this will install migrations that move some columns from spree\_products, spree\_taxons, to dedicated translation tables -> spree\_products\_translations, spree\_taxons\_translations etc.

If you're using raw SQL queries (either in the application code, or running in external tools), you may need to review the new structure and update your queries accordingly.

## Run Additional Commands for Frontend

If using [Spree Frontend](https://github.com/spree/spree_rails_frontend), run the following additional commands to get everything set up correctly with the updated gems:

```bash
bin/rails javascript:install:esbuild
bin/rails turbo:install
bin/rails g spree:frontend:install
yarn build
```

And that's a wrap! :tada:

## Additional fixes and hints

### Update migrations for translation tables with additional columns

If you want to translate more fields in [translated resources](https://dev-docs.spreecommerce.org/customization/i18n#resource-translations), you have to alter copied migrations or add new ones.
We're using the `Spree::TranslationMigrations` to help with migrating data, see [here](https://github.com/spree/spree/blob/main/core/lib/spree/translation_migrations.rb).

### Add or update the behavior of the translated model

Each translated resource has a corresponding `Translation` model, see [here](https://github.com/spree/spree/blob/v4.6.5/core/app/models/spree/product.rb#L44) for reference.
If you want to add some more behavior to the translation, you need to do it within the `Translation.class_eval` block.

If you replaced Spree models, you have to define this block yourself. Apart from that, please include these modules: 
- `Spree::TranslatableResource` - required for all translated models
- `Spree::TranslatableResourceSlug` - required for translated models with slugs/permalinks

You can read more how Spree handles resources translations [here](https://dev-docs.spreecommerce.org/customization/i18n#resource-translations-implementation).

### Generating slugs with friendly_id

Generating slugs/permalinks in `Spree::Product` and `Spree::Taxon` models is now based on the translated name. If you use the `history` plugin, read [here](https://github.com/shioyama/friendly_id-mobility?tab=readme-ov-file#slug-history) on how to use it with the `mobility` plugin.

### Resource translations and encryption

Currently, it's not possible to translate encrypted data. If you're already encrypting data that Spree translates, you need to remove that functionality.

### Full text search with pg_search scopes

If you use the [pg_search](https://github.com/Casecommons/pg_search) for the full text search in [translated resources](https://dev-docs.spreecommerce.org/customization/i18n#resource-translations), you need to move your scopes to the translated model, eg. from the `Spree::Product` to the `Spree::Product::Translation`. If you still want to have the original scope, you can rewrite it like this:

#### Before

```ruby
class Spree::Product < Spree::Base
  include PgSearch::Model
  pg_search_scope :search_by_name, against: :name
end
```

#### After

```ruby
class Spree::Product < Spree::Base
  self::Translation.class_eval do
    include PgSearch::Model
    pg_search_scope :search_by_name, against: :name
  end
  
  scope :search_by_name, lambda { |query|
    product_ids = Spree::Product::Translation.search_by_name(query).pluck(:spree_product_id)
    where(id: product_ids)
  }
end
```

## Read the release notes

For information about changes contained within this release, please read the [Spree 4.6.0 Release Notes](https://github.com/spree/spree/releases/tag/v4.6.0).
